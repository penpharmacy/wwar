<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>เครื่องคำนวณการให้ยา Warfarin โรงพยาบาลพุนพิน</title>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#E3F2FD; --card:#fff; --accent:#4CAF50; --muted:#607D8B; --pink:#FFEBEE;
      font-family: 'Kanit', sans-serif;
    }
    body{background:linear-gradient(180deg,var(--bg),#fff);margin:0;padding:20px;color:#263238}
    header{display:flex;align-items:center;gap:12px}
    h1{margin:0;font-size:20px;text-align:center;flex:1}
    .container{max-width:980px;margin:20px auto}
    .card{background:var(--card);border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.06);padding:18px;margin-bottom:16px}
    label{display:block;font-size:13px;margin-bottom:6px;color:var(--muted)}
    input[type=number]{width:100%;padding:10px;border-radius:8px;border:1px solid #eee;font-size:16px}
    .row{display:flex;gap:12px}
    .col{flex:1}
    .radio-row{display:flex;gap:12px;flex-wrap:wrap}
    .pill{padding:10px 14px;border-radius:18px;border:1px solid #eee;background:#fafafa}
    button.primary{background:var(--accent);color:#fff;border:0;padding:12px 18px;border-radius:10px;font-weight:600}
    .result{margin-top:12px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #f0f0f0;text-align:center}
    .small{font-size:13px;color:var(--muted)}
    .note{background:#FFF8E1;padding:8px;border-radius:8px;margin-top:8px;white-space:pre-line;}
    footer{font-size:13px;color:var(--muted);text-align:center;padding:8px}
    @media(max-width:720px){.row{flex-direction:column}}
  </style>
</head>
<body>
<div class="container">
  <header class="card" style="align-items:center">
    <h1>เครื่องคำนวณการให้ยา Warfarin โรงพยาบาลพุนพิน</h1>
  </header>

  <section class="card">
    <form id="form">
      <div class="row">
        <div class="col">
          <label>INR ปัจจุบัน</label>
          <input type="number" step="0.01" id="inr" min="0" value="2.5" required>
        </div>
        <div class="col">
          <label>ขนาดยา Warfarin ต่อสัปดาห์ (mg)</label>
          <input type="number" step="0.1" id="weeklyDose" min="0" value="35" required>
        </div>
        <div class="col">
          <label>จำนวนวันนัด (วัน)</label>
          <input type="number" id="days" min="1" value="7" required>
        </div>
      </div>

      <div style="margin-top:12px">
        <label>ชนิดเม็ดยาที่ใช้</label>
        <div class="radio-row">
          <label class="pill"><input type="radio" name="pills" value="3" checked> ใช้เม็ด 3 mg เท่านั้น</label>
          <label class="pill"><input type="radio" name="pills" value="2"> ใช้เม็ด 2 mg เท่านั้น</label>
          <label class="pill"><input type="radio" name="pills" value="both"> ใช้ทั้ง 2 และ 3 mg</label>
        </div>
      </div>

      <div style="margin-top:12px">
        <label>ภาวะเลือดออก</label>
        <div class="radio-row">
          <label class="pill"><input type="radio" name="bleed" value="no" checked> ไม่มี</label>
          <label class="pill"><input type="radio" name="bleed" value="yes"> มี</label>
        </div>
      </div>
    </form>

    <div id="results" class="result" style="display:none"></div>
  </section>

  <section id="tables" class="card" style="display:none">
    <h3>ตารางแผนการให้ยา (7 วัน)</h3>
    <div id="plans"></div>
    <div id="summary"></div>
    <div style="margin-top:12px;text-align:right">
      <button onclick="window.print()" class="primary">ดาวน์โหลด / พิมพ์ (PDF)</button>
    </div>
  </section>

  <footer class="card small">คำเตือน: เครื่องมือนี้เป็นเครื่องมือช่วยคำนวณเท่านั้น ไม่ใช่คำสั่งการรักษา เเพทย์/เภสัชกรเป็นผู้ตัดสินใจขั้นสุดท้าย</footer>
</div>

<script>
function roundHalf(x){return Math.round(x*2)/2}
function distributeEvenly(totalHalfUnits, days){
  const base = Math.floor(totalHalfUnits/days);
  let arr = Array(days).fill(base);
  let rem = totalHalfUnits - base*days;
  for(let i=0;i<rem;i++) arr[i]++;
  return arr;
}
function findBestCombo(target){
  if(target % 5 === 0){
    let num5 = target / 5;
    if(num5 <=7){
      return {h3:num5*2,h2:num5*2,total:num5*5};
    }
    const sets = Math.floor(num5 / 4);
    const rem = num5 % 4;
    const h3 = sets*4 + Math.min(rem*2, rem*2);
    const h2 = sets*4 + Math.max(0, rem*2 - h3);
    return {h3:h3,h2:h2,total:target};
  }
  let best = null;
  let max5 = Math.floor(target / 5);
  for(let n5=max5;n5>=0;n5--){
    let rem = target - n5*5;
    let n3 = Math.floor(rem / 3);
    let n2 = Math.round((rem - n3*3)/2);
    if(n3 + n2 === 0) continue;
    let total = n5*5 + n3*3 + n2*2;
    let diff = Math.abs(total - target);
    if(!best || diff < Math.abs(best.total - target)){
      best = {h3: n5*2 + n3*2, h2: n5*2 + n2*2, total: total};
    }
    if(diff < 0.01) break;
  }
  return best;
}
function buildPlanHTML(title, combo){
  const h3 = combo.h3; const h2 = combo.h2; const total = combo.total;
  const perDay3 = distributeEvenly(h3,7);
  const perDay2 = distributeEvenly(h2,7);
  let html = `<h4>${title} — รวม ${total.toFixed(1)} mg/สัปดาห์</h4>`;
  html += `<table><thead><tr><th>วัน</th><th>3 mg (เม็ด)</th><th>2 mg (เม็ด)</th><th>รวม (mg)</th></tr></thead><tbody>`;
  const dayNames = ['จันทร์','อังคาร','พุธ','พฤหัสบดี','ศุกร์','เสาร์','อาทิตย์'];
  for(let i=0;i<7;i++){
    const t3 = perDay3[i]/2;
    const t2 = perDay2[i]/2;
    const mg = t3*3 + t2*2;
    html += `<tr><td>${dayNames[i]}</td><td>${t3 % 1 === 0 ? t3 : t3.toFixed(1)}</td><td>${t2 % 1 === 0 ? t2 : t2.toFixed(1)}</td><td>${mg.toFixed(1)}</td></tr>`;
  }
  html += `</tbody></table>`;
  return html;
}

function calculate(){
  const inr = parseFloat(document.getElementById('inr').value);
  const weeklyDose = parseFloat(document.getElementById('weeklyDose').value);
  const days = parseInt(document.getElementById('days').value,10);
  const pillChoice = document.querySelector('input[name="pills"]:checked').value;
  const bleed = document.querySelector('input[name="bleed"]:checked').value;
  if(isNaN(inr)||isNaN(weeklyDose)||isNaN(days)){return}

  const resDiv = document.getElementById('results');
  const tables = document.getElementById('tables');
  const plansDiv = document.getElementById('plans');
  const summaryDiv = document.getElementById('summary');

  // ---------- กรณีเลือดออก ----------
  if(bleed === 'yes'){
    resDiv.innerHTML = `<div class="card"><p><strong>คำแนะนำ:</strong> พบภาวะเลือดออก: ให้ Vit K1 และพิจารณาการรักษาเฉียบพลันตามข้อแนะนำทางการแพทย์</p></div>`;
    resDiv.style.display = 'block';
    tables.style.display = 'none';  // ไม่แสดงตารางใดๆ
    plansDiv.innerHTML = '';
    summaryDiv.innerHTML = '';
    return;  // จบฟังก์ชัน ไม่คำนวณค่า Warfarin
  }

  // ---------- ส่วนคำนวณปกติ ----------
  let adj = {minPct:0,maxPct:0,avgPct:0,note:''};
  if(inr < 1.5){adj.minPct = 0.10; adj.maxPct = 0.20; adj.avgPct = 0.15; adj.note='เพิ่มขนาดยารายสัปดาห์ 10–20%';}
  else if(inr >=1.5 && inr <=1.9){adj.minPct = 0.05; adj.maxPct = 0.10; adj.avgPct = 0.075; adj.note='เพิ่ม 5–10% หรือพิจารณาไม่ปรับ แต่ติดตาม INR บ่อยขึ้น';}
  else if(inr >=2.0 && inr <=3.0){adj.minPct = 0; adj.maxPct = 0; adj.avgPct = 0; adj.note='ไม่ต้องปรับยา';}
  else if(inr >=3.1 && inr <=3.9){adj.minPct = -0.10; adj.maxPct = -0.05; adj.avgPct = -0.075; adj.note='ลดขนาดยารายสัปดาห์ 5–10%';}
  else if(inr >3.9 && inr <5.0){adj.minPct = -0.10; adj.maxPct = -0.10; adj.avgPct = -0.10; adj.note='หยุดยา 1 วัน แล้วกลับมาเริ่มด้วยขนาดที่ลดลง 10%';}
  else if(inr >=5.0 && inr <9.0){adj.minPct = -0.20; adj.maxPct = -0.20; adj.avgPct = -0.20; adj.note='หยุดยา 2 วัน แล้วกลับมาเริ่มด้วยขนาดที่ลดลง 20% — พิจารณาให้ Vitamin K₁ 1–2.5 mg ถ้ามีความเสี่ยงเลือดออก';}
  else if(inr >= 9.0){adj.minPct = null; adj.maxPct = null; adj.avgPct = null; adj.note='INR > 9.0: หยุดยา ให้ Vitamin K₁ 2.5–5 mg รับประทาน และติดตาม INR อย่างใกล้ชิด — ปรึกษาแพทย์/เภสัชกรเพื่อการปรับยา';}

  let newRange = {};
  if(adj.minPct===null){ 
    newRange.note = 'ไม่แนะนำให้คำนวณขนาดยาอัตโนมัติสำหรับ INR >= 9.0 — ให้ผู้เชี่ยวชาญประเมิน'; 
  } else{
    const min = weeklyDose * (1 + adj.minPct);
    const max = weeklyDose * (1 + adj.maxPct);
    const avg = weeklyDose * (1 + adj.avgPct);
    newRange = {
      minCalc: parseFloat(min.toFixed(1)),
      maxCalc: parseFloat(max.toFixed(1)),
      avgCalc: parseFloat(avg.toFixed(1)),
      min: roundHalf(min*2)/2,
      max: roundHalf(max*2)/2,
      avg: roundHalf(avg*2)/2
    };
  }

  let html = `<div class="card">`;
  html += `<p><strong>คำแนะนำ:</strong> INR = ${inr.toFixed(2)} — ${adj.note}</p>`;
  if(newRange.note){ html += `<p class="note">${newRange.note}</p>`; }
  else{
    html += `<p>ขนาดยาใหม่ต่อสัปดาห์ (mg) [คำนวณจริง]: <strong>${newRange.minCalc} — ${newRange.maxCalc}</strong> (เฉลี่ย ${newRange.avgCalc} mg)</p>`;
  }
  html += `</div>`;
  resDiv.innerHTML = html; 
  resDiv.style.display='block';

  // ---------- สร้างตาราง Warfarin ----------
  plansDiv.innerHTML = '';
  summaryDiv.innerHTML = '';
  if(newRange.min !== undefined){
    const targets = [
      {k:'ต่ำสุด',val:newRange.min},
      {k:'เฉลี่ย',val:newRange.avg},
      {k:'สูงสุด',val:newRange.max}
    ];
    let summaryData = {min:{},avg:{},max:{}};
    targets.forEach(t=>{
      let best;
      if(pillChoice === '3'){
        const h3 = Math.round((t.val / 1.5));
        best = {h3:h3,h2:0,total:h3*1.5};
      } else if(pillChoice === '2'){
        const h2 = Math.round(t.val / 1.0);
        best = {h3:0,h2:h2,total:h2*1.0};
      } else {
        best = findBestCombo(t.val);
      }
      if(t.k==='ต่ำสุด'){summaryData.min=best;}
      if(t.k==='เฉลี่ย'){summaryData.avg=best;}
      if(t.k==='สูงสุด'){summaryData.max=best;}
      plansDiv.innerHTML += buildPlanHTML(t.k, best);
    });

    const min3 = summaryData.min.h3 / 2 * (days / 7);
    const min2 = summaryData.min.h2 / 2 * (days / 7);
    const avg3 = summaryData.avg.h3 / 2 * (days / 7);
    const avg2 = summaryData.avg.h2 / 2 * (days / 7);
    const max3 = summaryData.max.h3 / 2 * (days / 7);
    const max2 = summaryData.max.h2 / 2 * (days / 7);

    const totalMinMg = summaryData.min.total * (days / 7);
    const totalAvgMg = summaryData.avg.total * (days / 7);
    const totalMaxMg = summaryData.max.total * (days / 7);

    summaryDiv.innerHTML = `สำหรับช่วงนัด ${days} วัน\n\n`+
      `ต่ำสุด: ต้องใช้รวม ${min3.toFixed(1)} เม็ด(3 mg) และ ${min2.toFixed(1)} เม็ด(2 mg) -> จำนวนเม็ดจริงที่ควรจ่าย (ปัดขึ้น): ${Math.ceil(min3)} เม็ด(3 mg), ${Math.ceil(min2)} เม็ด(2 mg).\n\n`+
      `เฉลี่ย: ต้องใช้รวม ${avg3.toFixed(1)} เม็ด(3 mg) และ ${avg2.toFixed(1)} เม็ด(2 mg) -> จำนวนเม็ดจริงที่ควรจ่าย (ปัดขึ้น): ${Math.ceil(avg3)} เม็ด(3 mg), ${Math.ceil(avg2)} เม็ด(2 mg).\n\n`+
      `สูงสุด: ต้องใช้รวม ${max3.toFixed(1)} เม็ด(3 mg) และ ${max2.toFixed(1)} เม็ด(2 mg) -> จำนวนเม็ดจริงที่ควรจ่าย (ปัดขึ้น): ${Math.ceil(max3)} เม็ด(3 mg), ${Math.ceil(max2)} เม็ด(2 mg).\n\n`+
      `ปริมาณรวม (mg): ต่ำสุด ${totalMinMg.toFixed(1)} mg, เฉลี่ย ${totalAvgMg.toFixed(1)} mg, สูงสุด ${totalMaxMg.toFixed(1)} mg.`;

    summaryDiv.classList.add('note');
    tables.style.display = 'block';
  } else {
    plansDiv.innerHTML = `<div class="note">${newRange.note}</div>`;
    tables.style.display = 'block';
  }
}

// -------------------- Event listeners --------------------
document.querySelectorAll('input[name="pills"]').forEach(el=>el.addEventListener('change', calculate));
document.querySelectorAll('input[name="bleed"]').forEach(el=>el.addEventListener('change', calculate));
document.getElementById('inr').addEventListener('input', calculate);
document.getElementById('weeklyDose').addEventListener('input', calculate);
document.getElementById('days').addEventListener('input', calculate);

// เรียกครั้งแรก
calculate();
</script>
</body>
</html>
